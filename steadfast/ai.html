<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Steadfast Bulk Booking Tool</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì¶</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f7f8; --card:#fff; --muted:#6b7280; --accent:#10b981; --danger:#ef4444; --border:#e6eef6; --text:#1f2937; --ai-purple: #8b5cf6; }
    body{margin:0;padding:14px;background:var(--bg);font-family: 'Poppins', system-ui, sans-serif;color:var(--text);}
    .wrap{max-width:1100px;margin:8px auto;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04);}
    h1{font-size:20px;margin:0 0 15px}
    .btn{display:inline-block;padding:10px 15px;border-radius:8px;border:0;cursor:pointer;font-weight:600;font-size:14px;transition:0.2s}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-secondary{background:#fff;color:#374151;border:1px solid #d1dbdb}
    .btn-ai{background:var(--ai-purple);color:#fff}
    
    .settings-bar{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:12px;border-radius:10px;margin-bottom:20px;border:1px solid var(--border)}
    
    textarea{width:100%;min-height:120px;padding:12px;border:1px solid #d1d5db;border-radius:8px;box-sizing:border-box;font-family: inherit;margin-bottom:15px; outline: none;}
    textarea:focus{border-color: var(--accent);}
    
    .ai-box { border: 2px dashed var(--ai-purple); border-radius: 12px; padding: 20px; background: #f5f3ff; margin-top: 25px; position: relative; }
    .ai-badge { position: absolute; top: -12px; right: 20px; background: var(--ai-purple); color: white; padding: 2px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
    
    .config-panel { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; }
    .config-input { display: flex; gap: 10px; margin-bottom: 10px; }
    .config-input input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; }

    .table-container{margin-top:20px;overflow-x:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border:1px solid var(--border);text-align:left}
    th{background:#f9fafb;font-weight:600}
    
    .parcel-id-box{display:flex;flex-direction:column;gap:4px;background:#e6fcf5;padding:6px;border-radius:6px;border:1px solid #c2f3e1;}
    .status-success{color:var(--accent);font-weight:bold}
    
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
    .modal-content { background:#fff; padding:25px; border-radius:12px; width:90%; max-width:400px; }

    .loader { display: inline-block; width: 14px; height: 14px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 0.8s linear infinite; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="settings-bar">
        <h1 style="margin:0">Steadfast Bulk Tool</h1>
        <button onclick="openSettings()" class="btn btn-secondary">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ (API Keys)</button>
    </div>

    <!-- API Status Info -->
    <div id="statusStrip" style="font-size:12px; margin-bottom:15px; color:var(--muted)">
        Steadfast: <span id="stStatus">üî¥</span> | Gemini AI: <span id="aiStatus">üî¥</span>
    </div>

    <!-- Section 1: Manual -->
    <section>
      <label style="display:block;margin-bottom:8px;font-weight:600">‡ßß. ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø (‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã --- ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®)</label>
      <textarea id="bulkInput" placeholder="‡¶®‡¶æ‡¶Æ: ‡¶Ø‡¶æ‡ßü‡ßá‡¶¶&#10;‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ‡¶Æ‡¶ø‡¶∞‡¶™‡ßÅ‡¶∞, ‡¶¢‡¶æ‡¶ï‡¶æ&#10;01700000000&#10;500&#10;---&#10;‡¶π‡¶æ‡¶Æ‡¶ø‡¶¶, ‡¶Ø‡¶∂‡ßã‡¶∞, 01800000000, 1000"></textarea>
      <div style="display:flex;gap:10px">
        <button id="extractBtn" class="btn btn-primary">‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button onclick="clearAll()" class="btn btn-secondary">‡¶∏‡¶¨ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
      </div>
    </section>

    <!-- Section 2: AI -->
    <section class="ai-box">
      <div class="ai-badge">AI SMART READ</div>
      <label style="display:block;margin-bottom:8px;font-weight:600; color: var(--ai-purple);">‡ß®. ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶è‡¶Ü‡¶á ‡¶∞‡¶ø‡¶°‡¶æ‡¶∞ (‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®)</label>
      <textarea id="aiInput" style="border-color: #c4b5fd; min-height: 80px;" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶û‡ßç‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®..."></textarea>
      <button id="aiExtractBtn" class="btn btn-ai">AI ‡¶¶‡¶ø‡ßü‡ßá ‡¶§‡¶•‡ßç‡¶Ø ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‚ú®</button>
      <span id="aiLoading" style="display: none; margin-left:10px; color:var(--ai-purple);"><div class="loader"></div></span>
    </section>

    <!-- Table -->
    <div class="table-container" id="tableWrap" style="display:none">
      <h3>‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (<span id="count">0</span>)</h3>
      <table id="orderTable">
        <thead>
          <tr>
            <th>#</th>
            <th>‡¶®‡¶æ‡¶Æ</th>
            <th>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</th>
            <th>‡¶´‡ßã‡¶®</th>
            <th>COD</th>
            <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
          </tr>
        </thead>
        <tbody id="orderBody"></tbody>
      </table>

      <div style="margin-top:20px; background:#f9fafb; padding:15px; border-radius:10px; border:1px dashed #ccc">
        <input type="text" id="commonNote" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;" placeholder="‡¶ï‡¶Æ‡¶® ‡¶®‡ßã‡¶ü (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)">
        <button id="submitBulkBtn" class="btn btn-primary" style="width:100%">‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶¶‡¶ø‡¶®</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
        <h3>‚öôÔ∏è API Settings</h3>
        <p style="font-size:12px; color:var(--muted)">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶™‡¶ø‡¶Ü‡¶á ‡¶ï‡¶ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§</p>
        
        <label style="font-size:13px; font-weight:600">Steadfast API Key</label>
        <input type="password" id="setStKey" style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd">
        
        <label style="font-size:13px; font-weight:600">Steadfast Secret Key</label>
        <input type="password" id="setStSecret" style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd">
        
        <hr>
        
        <label style="font-size:13px; font-weight:600">Gemini AI Key</label>
        <input type="password" id="setAiKey" style="width:100%; padding:8px; margin-bottom:20px; border:1px solid #ddd">
        
        <div style="display:flex; gap:10px">
            <button onclick="saveSettings()" class="btn btn-primary" style="flex:1">Save</button>
            <button onclick="closeSettings()" class="btn btn-secondary" style="flex:1">Close</button>
        </div>
    </div>
  </div>

  <script>
    const LS_ST_KEY = 'steadfastApiKey';
    const LS_ST_SECRET = 'steadfastSecretKey';
    const LS_AI_KEY = 'geminiApiKey_user';
    let orders = [];

    // --- Settings Logic ---
    function openSettings() {
        document.getElementById('setStKey').value = localStorage.getItem(LS_ST_KEY) || '';
        document.getElementById('setStSecret').value = localStorage.getItem(LS_ST_SECRET) || '';
        document.getElementById('setAiKey').value = localStorage.getItem(LS_AI_KEY) || '';
        document.getElementById('settingsModal').style.display = 'flex';
    }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function saveSettings() {
        localStorage.setItem(LS_ST_KEY, document.getElementById('setStKey').value.trim());
        localStorage.setItem(LS_ST_SECRET, document.getElementById('setStSecret').value.trim());
        localStorage.setItem(LS_AI_KEY, document.getElementById('setAiKey').value.trim());
        alert('Settings Saved!');
        updateStatus();
        closeSettings();
    }
    function updateStatus() {
        document.getElementById('stStatus').innerText = localStorage.getItem(LS_ST_KEY) ? 'üü¢' : 'üî¥';
        document.getElementById('aiStatus').innerText = localStorage.getItem(LS_AI_KEY) ? 'üü¢' : 'üî¥';
    }

    // --- Data Extraction ---
    function cleanNum(str) { return String(str).replace(/[^\d]/g, ''); }
    function cleanPrefix(txt) { return txt.replace(/^(‡¶®‡¶æ‡¶Æ|‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ|‡¶´‡ßã‡¶®|‡¶ü‡¶æ‡¶ï‡¶æ|Name|Address|Phone|COD)[:\s-]*/gi, '').trim(); }

    document.getElementById('extractBtn').onclick = () => {
        const val = document.getElementById('bulkInput').value.trim();
        if(!val) return;
        const chunks = val.split(/---|\n\n/).map(s => s.trim()).filter(Boolean);
        chunks.forEach(c => {
            const lines = c.split('\n').map(l => l.trim()).filter(Boolean);
            if(lines.length >= 2) {
                orders.push({
                    name: cleanPrefix(lines[0]),
                    address: cleanPrefix(lines[1]),
                    phone: cleanNum(lines[2] || ''),
                    cod: cleanNum(lines[3] || '0'),
                    status: 'Pending'
                });
            }
        });
        render();
        document.getElementById('bulkInput').value = '';
    };

    // --- AI Extraction ---
    document.getElementById('aiExtractBtn').onclick = async () => {
        const key = localStorage.getItem(LS_AI_KEY);
        const text = document.getElementById('aiInput').value.trim();
        if(!key || !text) return alert('API Key ‡¶è‡¶¨‡¶Ç ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶â‡¶≠‡ßü‡¶á ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡•§');

        document.getElementById('aiLoading').style.display = 'inline-block';
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{parts: [{text: text}]}],
                    systemInstruction: {parts: [{text: "Extract order: name, address, phone, cod. Return ONLY JSON array."}]},
                    generationConfig: {responseMimeType: "application/json"}
                })
            });
            const json = await res.json();
            const data = JSON.parse(json.candidates[0].content.parts[0].text);
            const list = Array.isArray(data) ? data : [data];
            list.forEach(o => {
                orders.push({
                    name: o.name || 'N/A',
                    address: o.address || 'N/A',
                    phone: cleanNum(o.phone),
                    cod: cleanNum(o.cod || '0'),
                    status: 'Pending'
                });
            });
            render();
            document.getElementById('aiInput').value = '';
        } catch(e) { alert('AI ‡¶è‡¶∞‡¶∞! ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'); }
        finally { document.getElementById('aiLoading').style.display = 'none'; }
    };

    function render() {
        const b = document.getElementById('orderBody');
        b.innerHTML = '';
        orders.forEach((o, i) => {
            b.innerHTML += `<tr><td>${i+1}</td><td>${o.name}</td><td>${o.address}</td><td>${o.phone}</td><td>${o.cod}</td><td id="st-${i}">${o.status}</td></tr>`;
        });
        document.getElementById('count').innerText = orders.length;
        document.getElementById('tableWrap').style.display = orders.length ? 'block' : 'none';
    }

    // --- Bulk Submission ---
    document.getElementById('submitBulkBtn').onclick = async () => {
        const apiKey = localStorage.getItem(LS_ST_KEY);
        const secret = localStorage.getItem(LS_ST_SECRET);
        const note = document.getElementById('commonNote').value;
        if(!apiKey || !secret) return alert('Steadfast API Key ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');

        document.getElementById('submitBulkBtn').disabled = true;
        for(let i=0; i<orders.length; i++){
            if(orders[i].status !== 'Pending') continue;
            const cell = document.getElementById(`st-${i}`);
            cell.innerText = '‚è≥...';
            
            try {
                const res = await fetch('https://portal.packzy.com/api/v1/create_order', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Api-Key': apiKey, 'Secret-Key': secret},
                    body: JSON.stringify({
                        invoice: 'B'+Date.now().toString(36),
                        recipient_name: orders[i].name,
                        recipient_address: orders[i].address,
                        recipient_phone: orders[i].phone,
                        cod_amount: orders[i].cod,
                        note: note,
                        delivery_type: 0
                    })
                });
                const d = await res.json();
                if(d.status === 200) {
                    orders[i].status = 'Success';
                    cell.innerHTML = `<div class="parcel-id-box"><span style="font-size:11px">ID: #${d.consignment.consignment_id}</span></div>`;
                } else { cell.innerText = '‚ùå Failed'; }
            } catch(e) { cell.innerText = '‚ö†Ô∏è Error'; }
            await new Promise(r => setTimeout(r, 600));
        }
        document.getElementById('submitBulkBtn').disabled = false;
    };

    function clearAll() { orders = []; render(); }
    updateStatus();
  </script>
</body>
</html>